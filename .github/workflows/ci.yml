name: 🛠 iOS CI Build

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

jobs:
  build-ios:
    runs-on: macos-latest
    env:
      DEVELOPER_DIR: /Applications/Xcode_15.4.app/Contents/Developer

    steps:
      - name: 📥 Checkout repository
        uses: actions/checkout@v3

      - name: 🔐 Setup security (macOS keychain for certs/profiles)
        run: |
          security create-keychain -p "" ios-build.keychain
          security default-keychain -s ios-build.keychain
          security unlock-keychain -p "" ios-build.keychain
          security set-keychain-settings

      - name: 🍺 Install dependencies
        run: |
          brew install xcodegen swiftlint

      - name: 🧰 Restore Xcode derived data cache
        uses: actions/cache@v3
        with:
          path: ~/Library/Developer/Xcode/DerivedData
          key: ${{ runner.os }}-xcode-derived-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-xcode-derived-

      - name: 🛠 Generate Xcode project
        run: xcodegen

      - name: 🧼 Lint Swift code
        run: swiftlint --strict || true

      - name: 🧪 Build app for iOS Simulator
        run: |
          xcodebuild clean build \
            -project iosChallenge.xcodeproj \
            -scheme iosChallenge \
            -sdk iphonesimulator \
            -destination 'platform=iOS Simulator,name=iPhone 14,OS=latest' \
            -configuration Debug \
            CODE_SIGNING_ALLOWED=NO

      - name: 📦 Export .app bundle
        run: |
          mkdir -p build_artifacts
          cp -R ~/Library/Developer/Xcode/DerivedData/*/Build/Products/Debug-iphonesimulator/*.app build_artifacts/

      - name: 📤 Upload build artifact
        uses: actions/upload-artifact@v3
        with:
          name: ios-app
          path: build_artifacts/*.app

      - name: ✅ Done
        run: echo "✅ CI Build & Artifact Export Completed!"
